@section title{
    <title>零售商-线路管理-线路订单管理-退订单</title>
}
<!--60px占高层-->
<div class="h60"></div>
<div class="part">
    <p class="position">◆当前位置： 线路管理 >> 发起退货</p>
    <!--搜索结果区域-->
    <div class="search_input_result_tab">
        <p>所选订单</p>
    </div>
    <div class="line_details_title">
        <div class="title_left">
            <h1><a href="~/Marketer/MHome/LineDetail?Id=@ViewBag.ChildProduct.ProductId"><small>No. @ViewBag.ChildProduct.Product.Id</small>@ViewBag.ChildProduct.Product.Name</a></h1>
            <p>批发商：<span class="f-lightblue">@ViewBag.ChildProduct.Product.User.Company.CompanyName</span></p>
            <p>发团时间：<span class="f-lightblue">@ViewBag.ChildProduct.Product.SendGroupTime.ToString("yyyy年MM月dd")</span>　　　可退数量：<span class="f-lightblue">@(ViewBag.ZhanWeiCount + ViewBag.list.Count)</span></p>
            <p>建议零售价：<span>@ViewBag.ChildProduct.Product.SuggestionPrice</span></p>
        </div>
        <div class="title_right">
            <div class="title_right_others">
                <p class="price">成人价：<span class="number">￥@ViewBag.ChildProduct.Product.ChengRenPrice</span>元</p>
                <p class="price">儿童价：<span class="number">￥@ViewBag.ChildProduct.Product.ErTongPrice</span>元</p>
            </div>
            <b class="waveline"></b>
        </div>
        <div class="h30 clear"></div>
        <hr>
        <div class="order_input">
            <input hidden="hidden" id="ProductId" name="Id" value="@ViewBag.ChildProduct.ProductId" />
            <input hidden="hidden" id="ChildProductId" name="Id" value="@ViewBag.ChildProduct.Id" />
            <div class="member_blank">
                @for (int i = 0; i < ViewBag.list.Count; i++)
                {
                    <div class="member_item" style="height:30px;">
                        <div class="member_item_head">
                            <span><input type="checkbox" style=" right: 0px; top: 6px;" class="member_item_head_check"></span>
                            <span style=" right: 25px;" class="member_item_head_fold">展开本条</span>
                            <span class="member_item_head_id" hidden="hidden">@ViewBag.list[i].Id</span>
                            <span style="margin-left: 10px;float: left;">#成员序号：@(i + 1) (共@(ViewBag.list.Count + ViewBag.ZhanWeiCount)位成员)</span>
                            <span style="margin-left: 5px;float: left;"> 成员姓名：@ViewBag.list[i].Name</span>
                        </div>
                        <div class="member_item_body" hidden="hidden">
                            <p>
                                成员类型：<select name="Type" style="width:80px;margin-right:50px;" disabled="disabled">
                                    @if (ViewBag.list[i].Type == 0)
                                    {
                                        <option value="0" selected="selected">成人</option>
                                        <option value="1">儿童</option>
                                    }
                                    else
                                    {
                                        <option value="0">成人</option>
                                        <option value="1" selected="selected">儿童</option>
                                    }
                                </select>
                                姓名：<input type="text" name="Name" value="@ViewBag.list[i].Name" readonly="readonly" style="width:100px;margin-right:50px;">
                                姓(拼音)：<input type="text" style="width: 70px; margin-right:50px;" readonly="readonly" name="PinYinXing" value="@ViewBag.list[i].PinYinXing">
                                名(拼音)：<input type="text" name="PinYinMing" value="@ViewBag.list[i].PinYinMing" readonly="readonly" style="width:70px;">

                            </p>
                            <p>
                                性别：<select name="Sex" style="width:80px;margin-right:45px;" disabled="disabled">
                                    @if (ViewBag.list[i].Sex == 0)
                                    {
                                        <option value="0" selected="selected">男</option>
                                        <option value="1">女</option>
                                    }
                                    else
                                    {
                                        <option value="0">男</option>
                                        <option value="1" selected="selected">女</option>
                                    }
                                </select>
                                电话（选填）：<input type="text" name="Phone" readonly="readonly" style="width:85px;margin-right:25px;" value="@ViewBag.list[i].Phone">
                                生日：<input type="text" name="Birthday" readonly="readonly" style="width:80px;margin-right:64px;" value="@ViewBag.list[i].Birthday">
                                出生地：<input type="text" name="Birthplace" readonly="readonly" value="@ViewBag.list[i].Birthplace">
                            </p>
                            <p>
                                证照类型：<select name="ZhengZhaoType" disabled="disabled" style="width:80px;margin-right:45px;max-width:none;">
                                    @if (ViewBag.list[i].ZhengZhaoType == 0)
                                    {
                                        <option value="0" selected="selected">身份证</option>
                                        <option value="1">护照</option>
                                        <option value="2">军人证</option>
                                        <option value="3">赴台证</option>
                                        <option value="4">港澳证</option>
                                    }
                                    else if (ViewBag.list[i].ZhengZhaoType == 1)
                                    {
                                        <option value="0">身份证</option>
                                        <option value="1" selected="selected">护照</option>
                                        <option value="2">军人证</option>
                                        <option value="3">赴台证</option>
                                        <option value="4">港澳证</option>
                                    }
                                    else if (ViewBag.list[i].ZhengZhaoType == 2)
                                    {
                                        <option value="0">身份证</option>
                                        <option value="1">护照</option>
                                        <option value="2" selected="selected">军人证</option>
                                        <option value="3">赴台证</option>
                                        <option value="4">港澳证</option>
                                    }
                                    else if (Model[i].ZhengZhaoType == 3)
                                    {
                                        <option value="0">身份证</option>
                                        <option value="1">护照</option>
                                        <option value="2">军人证</option>
                                        <option value="3" selected="selected">赴台证</option>
                                        <option value="4">港澳证</option>
                                    }
                                    else
                                    {
                                        <option value="0">身份证</option>
                                        <option value="1">护照</option>
                                        <option value="2">军人证</option>
                                        <option value="3">赴台证</option>
                                        <option value="4" selected="selected">港澳证</option>
                                    }
                                </select>

                                证照号：<input type="text" name="ZhengZhaoNumber" readonly="readonly" value="@ViewBag.list[i].ZhengZhaoNumber" style="width:130px;max-width:none;">
                            </p>
                            <p>
                                签发地：<input type="text" name="QianFaPlace" readonly="readonly" style="max-width: none;width: 140px;margin-right: 60px;" value="@ViewBag.list[i].QianFaPlace">
                                签发时间：<input type="text" name="QianFaTime" readonly="readonly" style="max-width: none;width: 120px;margin-right: 60px;" value="@ViewBag.list[i].QiangFaTime">
                                到期时间：<input type="text" name="DaoQiTime" readonly="readonly" style="max-width: none;width: 120px;" value="@ViewBag.list[i].DaoQiTime">
                            </p>
                            <p>
                                分房（选填）：<input type="text" readonly="readonly" style="width:615px;max-width:none;" name="FenFang" value="@ViewBag.list[i].FenFang">
                            </p>
                            <p>
                                备注（选填）：<input type="text" readonly="readonly" style="max-width:none;width:615px;" name="Note" value="@ViewBag.list[i].Note">
                            </p>
                        </div>
                    </div>
                }
                @for (int i = 0; i < ViewBag.ZhanWeiCount; i++)
                {
                    <div class="member_item" style="height:30px;">
                        <div class="member_item_head">
                            <span class="member_item_head_id" hidden="hidden">-1</span>
                            <span ><input type="checkbox" style =" right: 0px; top: 6px;" class="member_item_head_check"></span>
                            <span style="margin-left: 10px;float: left;">#成员序号：@(i + ViewBag.list.Count + 1) (共@(ViewBag.list.Count + ViewBag.ZhanWeiCount)位成员)</span>
                            <span style="margin-left: 5px;float: left;"> 该条信息尚未编辑</span>
                        </div>

                    </div>
                }
                </div>
                <p class="single" style="margin-top:-10px;">理由：<textarea id="reason" name="reason" cols="100"></textarea>
            <p class="single" style="margin-top:-30px;">
                <a href="javascript:history.go(-1)"><span class="btn_cancel">取消</span></a>
                <span id="submit" class="btn_cancel">确认退货</span>
            </p>
            </div>
    </div>
</div>
<!--/part结束-->
@section scripts{
    <script type="text/javascript">
        LeftMenuSelect(1);
    </script>
<script type="text/javascript">
    $(".member_item_head_fold").click(function () {
        if ($(this).text() == "折叠本条") {
            $(this).parent().parent().children(".member_item_body").hide();
            $(this).parent().parent().height(30);
            $(this).text("展开本条");
        }
        else {
            $(this).parent().parent().children(".member_item_body").show();
            $(this).parent().parent().height("auto");
            $(this).text("折叠本条");
        }
    });
</script>
<script type="text/javascript">
    $("#submit").click(function () {
        var regBox = {
            regprice: /^[+-]?([0-9]*\.?[0-9]+|[0-9]+\.?[0-9]*)([eE][+-]?[0-9]+)?$/,
            regCount: /^[1-9]\d*$/
        }
        AllCount = 0;
        CustomerIdList = "";
        $(".member_item_head_check").each(function () {
            if($(this).attr("checked"))
            {
                AllCount++;
                if ($(this).parent().parent().children(".member_item_head_id").html() != -1)
                {
                    CustomerIdList += $(this).parent().parent().children(".member_item_head_id").html() + ","
                }
            }
        });
        if (CustomerIdList != "")
        {
            CustomerIdList = CustomerIdList.substr(0, CustomerIdList.length-1);
        }
        var Reason = $("#reason").val();
        if (AllCount == 0) {
            alert("请至少选择退一位！");
            return;
        }       
        if (Reason == '') {
            alert("理由不可为空！");
            return;
        }
        $.ajax(
                 {
                     url: "/Marketer/MLine/ReturnOrder",
                     type: "POST",
                     data:
                         {
                             ProductId: $("#ProductId").val(),
                             ChildProductId: $("#ChildProductId").val(),
                             AllCount: AllCount,
                             CustomerIdList: CustomerIdList,
                             Reason: $("#reason").val()
                         },
                     beforeSend: function (XMLHttpRequest) {
                         $("#submit").html("正在提交，请不要关闭页面");
                         $("#submit").addClass('stop');
                     },
                     success: function (data, textStatus) {
                         if (data == "200") {
                             alert("退单提交成功");
                             window.location = "/Marketer/MLine/Order?Id=" + "@ViewBag.ChildProduct.Id"
                         } else if (data == "100") {
                             alert("数量超出");
                             window.location.reload();
                         } else {
                             alert("未知原因");
                         }
                     },
                     complete: function (XMLHttpRequest, textStatus) {
                         $("#submit").html("确认创建");
                         $("#submit").removeClass('stop');
                     },
                     error: function () {
                         alert("好像出错了，请刷新页面重试");
                     }
                 })
    });
</script>

}