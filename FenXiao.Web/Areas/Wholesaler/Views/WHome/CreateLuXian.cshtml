@{
    Layout = "~/Areas/Wholesaler/Views/Shared/_Layout.cshtml";
}

@section styles{
    <meta name="viewport" content="width=device-width" />
    <title>添加新动态</title>
    <link type="text/css" href="http://code.jquery.com/ui/1.9.1/themes/smoothness/jquery-ui.css" rel="stylesheet" />
    <link href="~/Scripts/jQueryTimepickerAddon/jquery-ui-timepicker-addon.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="~/Scripts/webuploader/webuploader.css">
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="http://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
    <!--引入JS-->
    <script type="text/javascript" src="~/Scripts/webuploader/webuploader.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/Scripts/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/Scripts/ueditor/ueditor.all.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/Scripts/ueditor/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript">
        // 文件上传
        $(function () {
            var $ = jQuery,
                $list = $('#thelist'),
                $btn = $('#ctlBtn'),
                state = 'pending',
                uploader;

            uploader = WebUploader.create({
                // 自动上传。
                auto: true,
                // 不压缩image
                resize: false,

                // swf文件路径
                swf: '/Scripts/webuploader/Uploader.swf',

                // 文件接收服务端。
                server: '/Home/Upload',

                // 选择文件的按钮。可选。
                // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                pick: '#picker',
                threads: 1
            });
            // 文件上传过程中创建进度条实时显示。
            uploader.on('uploadProgress', function (file, percentage) {
                var $li = $('#' + file.id),
                    $percent = $li.find('.progress .progress-bar');

                // 避免重复创建
                if (!$percent.length) {
                    $percent = $('<div class="row"><div class="col-md-5"><div class="progress progress-striped active">' +
                      '<div class="progress-bar" role="progressbar" style="width: 0%">' +
                      '</div>' +
                    '</div></div></div>').appendTo($li).find('.progress-bar');
                }

                $li.find('p.state').text('上传中');

                $percent.css('width', percentage * 100 + '%');
            });
            //后端返回数据
            uploader.on('uploadAccept', function (object, ret) {
                var files = uploader.getFiles();
                var filesLength = files.length;
                if (filesLength > 1) {
                    AudioUploader.removeFile(files[filesLength - 2].id);
                }
                $("#namefile").html(files[filesLength - 1].name);
                $("#inpimageCover").attr("value", ret._raw);
            });
        });
    </script>
}
<div class="h60"></div>
<div class="part">
    <p class="position">◆当前位置：发布线路</p>
    <div class="line_release">
        <div class="single_item">
            <div class="left_item">
                <span>线路名称</span>
            </div>
            <div class="right_item">
                <input id="name" type="text" placeholder="填写线路的名称">
            </div>
        </div>
        <div class="single_item">
            <div class="left_item">
                <span>线路数量</span>
            </div>
            <div class="right_item">
                <input id="count" type="text" placeholder="填写线路的数量">
            </div>
        </div>
        <div class="single_item">
            <div class="left_item">
                <span>成人价格</span>
            </div>
            <div class="right_item">
                <input id="chengrenprice" type="text" placeholder="填写本线路的成人价格"> <small>　　(单位：元)</small>
            </div>
        </div>
        <div class="single_item">
            <div class="left_item">
                <span>儿童价格</span>
            </div>
            <div class="right_item">
                <input id="ertongprice" type="text" placeholder="填写本线路的儿童价格"> <small>　　(单位：元)</small>
            </div>
        </div>
        <div class="single_item">
            <div class="left_item">
                <span>建议卖价</span>
            </div>
            <div class="right_item">
                <input id="suggestprice" type="text" placeholder="填写本线路的推荐零售价"> <small>　　(建议卖价描述)</small>
            </div>
        </div>
        <div class="single_item_fortype" id="CheckRouteType">
            <div class="left_item">
                <span>类别选择</span>
            </div>
            <div class="right_item">
                @Html.Action("LuXianType")
            </div>
            <div class="clear"></div>
        </div>
        @*<div class="single_item_text">
                <div class="left_item">
                    <span>行程特色</span>
                </div>
                <div class="right_item">
                    <textarea cols="20" rows="3" id="tese" type="text"></textarea>
                </div>
                <div class="clear"></div>
            </div>
            <div class="single_item_text">
                <div class="left_item">
                    <span>行程安排</span>
                </div>
                <div class="right_item padding">
                    <script id="editor" type="text/plain" name="xingcheng">
                    </script>
                </div>
                <div class="clear"></div>
            </div>*@
        <div class="single_item_text">
            <div class="left_item">
                <span>说明</span>
            </div>
            <div class="right_item padding">
                <script id="editor1" type="text/plain" name="shuoming">

                </script>
            </div>
            <div class="clear"></div>
        </div>
        @*<div class="single_item_text">
                <div class="left_item">
                    <span>注意</span>

                </div>
                <div class="right_item padding">
                    <script id="editor2" type="text/plain" name="zhuyishixiang">
                    </script>
                </div>
                <div class="clear"></div>
            </div>*@

        <div class="single_item" style="margin-top:50px;">
            <div class="left_item">
                <span>上传线路附件</span>
            </div>
            <div class="right_item">
                <div class="btns">
                    <div id="picker">选择附件</div> <span id="namefile"></span>
                </div>
                <div id="thelist" class="uploader-list"></div>

                <input id="inpimageCover" type="text" style="display:none" />
            </div>
            <div class="clear"></div>
        </div>
        <style type="text/css">
            .ui-datepicker {
                z-index: 1010 !important;
            }
        </style>
        <div class="single_item_text" style="margin-top:50px;">
            <div class="left_item">
                <span>添加发团时间</span>
            </div>
            <div class="right_item" id="dateContainer">
                <span id="adddatepick" class="btn_sub">添加发团时间</span><span class="error">点击输入框添加日期，若添加更多发团时间，则点击添加日期按钮继续增加条目。</span>
                @*<div class="input-group date form_datetime date_plus" data-date="1979-09-16T05:25:07Z" data-date-format="dd MM yyyy - HH:ii p" data-link-field="dtp_input1">
                        <input class="dateinfo" class="form-control" size="16" type="text" value="" readonly>
                        <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                        <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                    </div>*@
            </div>
            <div class="clear"></div>
        </div>
        <div class="single_item">
            <div class="left_item">
                <span>发团时间</span>
            </div>
            <div class="right_item">
                <input type="text" class="form_datetime"
                       value="" readonly>
            </div>
        </div>

        <div id="addtimecor"></div>
        <div class="single_item_btn">
            <span id="submitinfo" class="btn_sub">确认添加</span>
            <span id="canclebtn" class="btn_cancel"><a href="/Wholesaler/WHome/MyLuXian">取消添加</a></span>
            <span id="errorInfor" style="color:red"></span>
            <div class="clear"></div>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript" src="http://code.jquery.com/ui/1.9.1/jquery-ui.min.js"></script>
    <script src="~/Scripts/jQueryTimepickerAddon/jquery-ui-timepicker-addon.js" type="text/javascript"></script>
    <script src="~/Scripts/jQueryTimepickerAddon/js/jquery.ui.datepicker-zh-CN.js.js" type="text/javascript" charset="gb2312"></script>
    <script src="~/Scripts/jQueryTimepickerAddon/js/jquery-ui-timepicker-zh-CN.js" type="text/javascript"></script>
    <script type="text/javascript">
        //var ue = UE.getEditor('editor', { initialFrameHeight: 400, initialFrameWidth: 600 });
        var ue1 = UE.getEditor('editor1', { initialFrameHeight: 400, initialFrameWidth: 600 });
        //var ue2 = UE.getEditor('editor2', { initialFrameHeight: 400, initialFrameWidth: 600 });
        function Cherk() {
            var regBox = {
                regprice: /^[+-]?([0-9]*\.?[0-9]+|[0-9]+\.?[0-9]*)([eE][+-]?[0-9]+)?$/,
                regCount: /^[1-9]\d*$/
            }
            var ertongprice = $("#ertongprice").val();
            var chengrenprice = $("#chengrenprice").val();
            var mflag = regBox.regprice.test(ertongprice);
            var tflag = regBox.regprice.test(chengrenprice);
            if ($("#name").val() == '') {
                $("#errorInfor").html("线路名称不能为空");
                return false;
            }
            else if ($("#count").val() == '') {
                $("#errorInfor").html("数量不能为空");
                return false;
            }
            else if (!regBox.regCount.test($("#count").val())) {
                $("#errorInfor").html("数量必须大于零的整数");
                return false;
            }
            else if (!mflag) {
                $("#errorInfor").html("儿童价格必须为正数");
                return false;
            }
            else if (!tflag) {
                $("#errorInfor").html("成人价格必须为正数");
                return false;
            }
            else
                return true;
        }

        $("#submitinfo").click(function () {
            if ($("#submitinfo").hasClass('stop')) {
                return false;
            }
            if (!Cherk()) {
                return false;
            }
            $("#errorInfor").html("");
            var date = "";
            var v = $(".form_datetime").each(function () {
                date += $(this).val() + "+";
            });
            date = date.substring(0, date.length - 1);
            if (date == "") {
                alert('发团日期至少填一个!')
                return false;
            }
            var _string = "";
            $("input[type='radio']:checked").each(function () {
                _string = _string + $(this).data("key") + "+";
            });
            var _string = _string.substring(0, _string.length - 1);
            //ajax提交
            $.ajax({
                url: "/Wholesaler/WHome/CreateLuXian",
                type: "POST",
                data: {
                    name: $("#name").val(),
                    chengrenprice: $("#chengrenprice").val(),
                    ertongprice: $("#ertongprice").val(),
                    suggestprice: $("#suggestprice").val(),
                    //tese: $("#tese").val(),
                    //xingcheng: ue.getContent(),
                    shuoming: ue1.getContent(),
                    //zhuyi: ue2.getContent(),
                    data: date,
                    type: _string,
                    Count: $("#count").val(),
                    fujian: $("#inpimageCover").val()
                },
                beforeSend: function (XMLHttpRequest) {
                    $("#submitinfo").html("正在创建请稍后，请不要关闭页面");
                    $("#submitinfo").addClass('stop');
                },
                success: function (data, textStatus) {
                    if (data == "1") {
                        window.location = "/Wholesaler/WHome/MyLuXian";
                    }
                    else {
                        alert(data);
                    }
                },
                complete: function (XMLHttpRequest, textStatus) {
                    $("#submitinfo").html("确认创建");
                    $("#submitinfo").removeClass('stop');
                },
                error: function () {
                    alert("好像出错了，请刷新页面重试");
                }
            })
        });
    </script>


    <script type="text/javascript">
        $(function () {
            $('.form_datetime').datetimepicker({
                language: 'zh-CN',
                format: "yyyy-mm-dd hh:ii:ss",
                todayBtn: 1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                startDate: '@DateTime.Now.ToString("yyyy-mm-dd")'
            });
        });
        $("#adddatepick").click(function () {
            $("#addtimecor").append('<div class="single_item">\
                <div class="left_item">\
                    <span>发团时间</span>\
                </div>\
                <div class="right_item">\
                    <input type="text" class="form_datetime" value="" readonly>\
                </div>\
            </div>');
            $('.form_datetime').datetimepicker({
                language: 'zh-CN',
                format: "yyyy-mm-dd hh:ii:ss",
                todayBtn: 1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                startDate: '@DateTime.Now.ToString("yyyy-mm-dd")'
            });
        })
    </script>
    <script type="text/javascript">
        $("#Menu").children("li").eq(0).removeClass("active");
        $("#Menu").children("li").eq(1).removeClass("active");
        $("#Menu").children("li").eq(2).removeClass("active");
        $("#Menu").children("li").eq(3).removeClass("active");
        $("#Menu").children("li").eq(4).removeClass("active");
        $("#Menu").children("li").eq(5
            ).removeClass("active");
        $("#Menu").children("li").eq(0).addClass("active");
    </script>
}
